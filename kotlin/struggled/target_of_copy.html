<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>πの実</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="個人的な備忘録です。主に初心者の方の疑問解消に少しでも役立てれば幸いです。"
    />
    <meta
      name="keywords"
      content="C,C++,C#,Kotlin,ROOT,CERN,Android,R,初心者,入門,文法"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/js/highlight/styles/darcula.css" />
    <script src="/js/highlight/highlight.pack.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script
    ><![endif]-->
  </head>

  <script type="text/javascript" src="/js/embed-date.js"></script>

  <script type="text/javascript">
    window.addEventListener(
      "load",
      function () {
        embedDate();
      },
      false
    );
  </script>

  <body>
    <div id="menubar">
      <ul>
        <li><a href="/index.html">Home</a></li>
        <li>
          <a>Contents <span class="caret"></span></a>
          <div>
            <ul id="contents">
              <script
                type="text/javascript"
                src="/js/embed-content-list.js"
              ></script>
            </ul>
          </div>
        </li>
      </ul>
    </div>
    <div id="container">
      <header>
        <div id="logo" style="text-align: center">
          <a href="/index.html">
            <img src="/images/logo.png" style="width: 150px; height: 46px"
          /></a>
        </div>
      </header>

      <div id="date" style="text-align: right">
        <p>更新日: 2021/9/13</p>
      </div>

      <h1 style="text-align: center">まとめ</h1>
      <ul>
        <li>
          data class
          のプロパティは、特に理由がない限りはプライマリコンストラクタ中で宣言したほうが良い
        </li>
        <li>
          プライマリコンストラクタ意外で定義したプロパティは、equals(),
          hashCode(), copy()メソッドの生成時に考慮されない
        </li>
      </ul>

      <h2>data class の copy()メソッドは primary constructor に基づく</h2>
      <p>
        data class
        を作ると、Kotlin側で自動的に下記の5つのメソッドを実装してくれ、私たちは特に気にしなくても便利にデータクラスを使えるのでした。
      </p>
      <ul>
        <li>
          equals(): プロパティの同一性を true / false
          の2値で返してくれるメソッド
        </li>
        <li>
          hashCode(): プロパティを基に一意なハッシュ値を生成してくれるメソッド
        </li>
        <li>toString(): インスタンスを文字列出力したときのフォーマット</li>
        <li>componentN(): N番目のプロパティへのアクセサ</li>
        <li>
          <b
            >copy():
            元のプロパティと同じ値を持った別のインスタンスを生成してくれるメソッド</b
          >
        </li>
      </ul>
      <p>
        今回は、copy()
        メソッドではいかなるプロパティも自動でコピーしてくれると思っていてハマったお話です。
      </p>

      <p>
        結論として、copy() メソッドでコピーしてくれるのは<b
          >data class の primary constructor で宣言されているプロパティのみ</b
        >です。データクラスの実装上、
        コンストラクタ以外の部分でもプロパティを定義することができますが、それらは
        copy() メソッドの対象外になってしまうので注意が必要です。 このことは<a
          href="https://kotlinlang.org/docs/data-classes.html#:~:text=from%20all%20properties%20declared%20in%20the%20primary%20constructor%3A"
          >公式ドキュメント</a
        >にも(分かりづらいですが)ちゃんと書いてありました。自動的に生成される5メソッドは、あくまで<b>プライマリコンストラクタで宣言されたプロパティだけ</b>を対象として生成されるということですね。
      </p>

      <h2>例</h2>
      <p>
        例えば下記のような実装をすると、isAdult はdata class Human
        のプロパティではありますが、 copy() メソッドで値がコピーされません。
      </p>
      <pre>
        <code>
          data class Human(
            val name: String,
            val age: Int,
        ){
            var isAdult: Boolean = false // コンストラクタ外での定義
        }

          fun notCopied() {
            val human = Human(name = "mtakamur", age = 27)
            if (human.age >= 20) human.isAdult = true // プロパティを更新
    
            val copiedHuman = human.copy()
    
            println("human = $human, isAdult = ${human.isAdult}")
            println("copiedHuman = $copiedHuman, isAdult = ${copiedHuman.isAdult}")
        }
        </code>
      </pre>

      <pre>
        <code>
          human = Human(name=mtakamur, age=27), isAdult = true
          copiedHuman = Human(name=mtakamur, age=27), isAdult = false // 変えたはずなのに…。
        </code>
      </pre>

      <p>
        isAdult
        の定義をちゃんとプライマリコンストラクタに移動してあげると、isAdult も
        copy() によって複製されるようになります。
      </p>

      <p>
        そもそもデータクラス(値の塊をパックする入れ物)という概念上、上記のような実装は避けるべきかもしれません。コンストラクタ以外の場所でプロパティを定義したい場合には下記のようにすると安全そうです。
      </p>
      <pre>
        <code>
          data class ModifiedHuman(
            val name: String,
            val age: Int
        ) {
            val isAdult = age >= 20
        }
        </code>
      </pre>

      <p>
        ポイントはコンストラクタ外のプロパティの値は、<b>コンストラクタで宣言されている値のみに依存させる</b>ということです。そうしておけば、copy()
        時にもコンストラクタで宣言されている値を追いかけることができるようになります。
      </p>
    </div>
  </body>
</html>
